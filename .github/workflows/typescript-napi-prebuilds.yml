name: TypeScript N-API Prebuilds
on:
  workflow_dispatch:
permissions:
  contents: read
  actions: write
env:
  CARGO_TERM_COLOR: always
jobs:
  build-linux:
    name: Build Linux prebuilds
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.12.0
      - name: Install Rust targets
        shell: bash
        run: |
          set -euo pipefail
          # arm64-gnu built natively on ubuntu-latest-arm64-s (build-linux-arm64 job)
          rustup target add \
            x86_64-unknown-linux-musl
      - name: Install Node dependencies
        working-directory: bindings/typescript
        run: npm install
      - name: Build .node files (zig)
        working-directory: bindings/typescript
        shell: bash
        run: |
          set -euo pipefail
          rm -f ipcprims.*.node
          mkdir -p prebuilds

          # glibc baseline (2.17) for broad compatibility
          npx napi build --cargo-cwd . --release --platform --js false --strip \
            --target x86_64-unknown-linux-gnu --zig --zig-abi-suffix 2.17
          mv ipcprims.linux-x64-gnu.node prebuilds/

          npx napi build --cargo-cwd . --release --platform --js false --strip \
            --target x86_64-unknown-linux-musl --zig
          mv ipcprims.linux-x64-musl.node prebuilds/
      - name: Upload prebuilds
        uses: actions/upload-artifact@v4
        with:
          name: ts-prebuilds-linux
          path: bindings/typescript/prebuilds/*.node
  build-linux-arm64:
    name: Build Linux arm64 prebuild (native)
    runs-on: ubuntu-latest-arm64-s
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install Node dependencies
        working-directory: bindings/typescript
        run: npm install
      - name: Build .node file
        working-directory: bindings/typescript
        shell: bash
        run: |
          set -euo pipefail
          rm -f ipcprims.*.node
          mkdir -p prebuilds
          npx napi build --cargo-cwd . --release --platform --js false --strip
          mv ipcprims.linux-arm64-gnu.node prebuilds/
      - name: Upload prebuild
        uses: actions/upload-artifact@v4
        with:
          name: ts-prebuilds-linux-arm64-gnu-native
          path: bindings/typescript/prebuilds/*.node
  build-macos-arm64:
    name: Build macOS arm64 prebuild
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install Node dependencies
        working-directory: bindings/typescript
        run: npm install
      - name: Build .node file
        working-directory: bindings/typescript
        shell: bash
        run: |
          set -euo pipefail
          rm -f ipcprims.*.node
          mkdir -p prebuilds
          npx napi build --cargo-cwd . --release --platform --js false --strip
          mv ipcprims.darwin-arm64.node prebuilds/
      - name: Upload prebuild
        uses: actions/upload-artifact@v4
        with:
          name: ts-prebuilds-darwin-arm64
          path: bindings/typescript/prebuilds/*.node
  build-windows:
    name: Build Windows x64 prebuild
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install Node dependencies
        working-directory: bindings/typescript
        run: npm install
      - name: Build .node file
        working-directory: bindings/typescript
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Remove-Item -Force ipcprims.*.node -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path prebuilds | Out-Null
          npx napi build --cargo-cwd . --release --platform --js false --strip
          Move-Item ipcprims.win32-x64-msvc.node prebuilds/
      - name: Upload prebuild
        uses: actions/upload-artifact@v4
        with:
          name: ts-prebuilds-win32-x64-msvc
          path: bindings/typescript/prebuilds/*.node
  package:
    name: Package (npm dir)
    runs-on: ubuntu-latest
    needs: [build-linux, build-linux-arm64, build-macos-arm64, build-windows]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Node dependencies
        working-directory: bindings/typescript
        run: npm install
      - name: Build native addon (for root package)
        working-directory: bindings/typescript
        run: npm run build:native
      - name: Remove local .node from root dist
        working-directory: bindings/typescript
        shell: bash
        run: |
          set -euo pipefail
          rm -f ipcprims.*.node || true
      - name: Download prebuilds
        uses: actions/download-artifact@v4
        with:
          pattern: ts-prebuilds-*
          path: downloaded-prebuilds
      - name: Create npm package templates
        working-directory: bindings/typescript
        shell: bash
        run: |
          set -euo pipefail
          rm -rf npm
          npx napi create-npm-dir -t .
      - name: Remove unsupported platform packages
        working-directory: bindings/typescript
        shell: bash
        run: |
          set -euo pipefail
          # ipcprims supports 5 platforms: linux-x64-gnu, linux-x64-musl,
          # linux-arm64-gnu, darwin-arm64, win32-x64-msvc
          # Remove any others that napi create-npm-dir generates
          for dir in npm/*/; do
            base=$(basename "$dir")
            case "$base" in
              linux-x64-gnu|linux-x64-musl|linux-arm64-gnu|darwin-arm64|win32-x64-msvc) ;;
              *) rm -rf "$dir"; echo "Removed unsupported platform: $base" ;;
            esac
          done
      - name: Stage .node files into npm packages
        working-directory: bindings/typescript
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob globstar
          for f in ../../downloaded-prebuilds/**/*.node; do
            base="$(basename "$f")"
            plat="${base#ipcprims.}"
            plat="${plat%.node}"
            dest="npm/${plat}/${base}"
            mkdir -p "$(dirname "$dest")"
            cp "$f" "$dest"
          done
      - name: Upload npm dir
        uses: actions/upload-artifact@v4
        with:
          name: ts-npm-dir
          path: bindings/typescript/npm
