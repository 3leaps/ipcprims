# ipcprims - AI Agent Guide

## Read First

1. Check `AGENTS.local.md` if it exists (gitignored, tactical session guidance)
2. Read `MAINTAINERS.md` for contacts and governance
3. Review this document for operational protocols
4. Understand: this is a **Rust library with cross-language bindings** — correctness is paramount

> **NOTE**: This repository handles IPC transport code that parses untrusted input from
> peer connections. Wire format parsing must be defensive. Buffer overflows or malformed
> frame handling can crash services or cause silent data corruption.

## Operating Model

| Aspect         | Setting                                  |
| -------------- | ---------------------------------------- |
| Mode           | Supervised (human reviews before commit) |
| Classification | code-substantive, security-sensitive     |
| Role Required  | Yes                                      |
| Default Role   | devlead                                  |
| Identity       | Per session (no persistent memory)       |

This repository is classified as **security-sensitive** because:

- IPC transport code handles untrusted peer connections
- Wire format parsing requires defensive input handling
- FFI boundary requires careful memory safety
- Cross-platform socket/pipe behavior must be predictable

See [agent-identity standard](https://crucible.3leaps.dev/repository/agent-identity) for modes and attribution.

## Project Overview

**ipcprims** is a permissively licensed, cross-platform IPC primitives library implemented in Rust with first-class bindings for Go, Python, and TypeScript.

**Core differentiator**: Framed-by-default message delivery with channel multiplexing — every read is a complete, valid message or an explicit error.

**Key principle**: Reliable inter-process communication with permissive licensing.

## Quick Reference

| Task           | Command            |
| -------------- | ------------------ |
| Build          | `cargo build`      |
| Test           | `cargo test`       |
| Format         | `cargo fmt`        |
| Lint           | `cargo clippy`     |
| License check  | `cargo deny check` |
| Security audit | `cargo audit`      |
| Full check     | `make check`       |

## Session Protocol

### Before Changes

- Read relevant code first
- Understand cross-platform implications of changes
- Keep changes minimal and focused
- Consider FFI boundary impacts
- Understand the wire format before modifying frame code

### Before Committing

- Run `cargo fmt && cargo clippy` (or `make check`)
- Run `cargo test` on available platforms
- Run `cargo deny check licenses`
- Verify no unintended changes with `git diff`
- Use proper commit attribution (see below)

## Commit Attribution

Follow [3leaps commit style](https://crucible.3leaps.dev/repository/commit-style):

```
<type>(<scope>): <subject>

<body>

Generated by <Model> via <Interface> under supervision of @<maintainer>

Co-Authored-By: <Model> <noreply@3leaps.net>
Role: <role>
Committer-of-Record: <Full Name> <email> [@<github-handle>]
```

**Example:**

```
feat(frame): implement channel multiplexing in wire format

Adds channel ID field to frame header, enabling multiple logical
streams over a single transport connection.

Changes:
- Add 2-byte channel ID to frame header (total header: 8 bytes)
- Define built-in channel IDs (CONTROL, COMMAND, DATA, TELEMETRY, ERROR)
- User-defined channels start at 256

Generated by Claude Opus via Claude Code under supervision of @3leapsdave

Co-Authored-By: Claude Opus <noreply@3leaps.net>
Role: devlead
Committer-of-Record: Dave Thompson <dave.thompson@3leaps.net> [@3leapsdave]
```

> **Attribution email policy**: All AI model Co-Authored-By trailers MUST use `noreply@3leaps.net` as the
> email address, regardless of model vendor. This prevents third-party email squatting on GitHub's
> contributor attribution. The model name in the name field provides the transparency; the email is
> plumbing under our control. Do NOT use vendor noreply addresses (`noreply@anthropic.com`,
> `noreply@openai.com`, etc.).

## Safety Protocols

### Wire Format Safety

When modifying frame codec or transport code:

- [ ] Validate all length fields before allocating buffers
- [ ] Check magic bytes before parsing further
- [ ] Enforce maximum payload size limits
- [ ] Handle partial reads correctly (don't assume full frames)
- [ ] Test with malformed input (truncated, oversized, bad magic)

### FFI Safety

FFI boundary changes require extra scrutiny:

- Memory ownership must be explicit
- All returned strings freed via appropriate free function
- No complex structs across FFI (JSON strings only)

## DO / DO NOT

### DO

- Run `cargo fmt && cargo clippy` before commits
- Read files before editing them
- Keep changes focused on the task
- Run tests on all available platforms before PRs
- Document platform-specific behavior
- Consider FFI memory safety implications
- Use `#[cfg(unix)]` and `#[cfg(windows)]` appropriately
- Test frame parsing with adversarial input

### DO NOT

- Push without maintainer approval
- Skip quality gates or license checks
- Commit secrets or credentials
- Add GPL/LGPL/AGPL dependencies
- Touch code outside task scope without justification
- Change FFI contracts without review
- Use `unsafe` without clear justification and review
- Assume platform behavior without testing
- **EVER commit anything from `.plans/`** - this directory is gitignored and MUST stay local
- Commit `AGENTS.local.md` (gitignored - session-specific guidance)

## Critical Rules

### Never Push Without Approval

Git push operations require explicit, per-incident human maintainer approval:

```bash
git add <files>       # OK
git commit -m "..."   # OK
git push              # NEVER without explicit approval
```

### License Compliance

All dependencies must pass `cargo deny check`:

```bash
cargo deny check licenses    # Must pass
cargo deny check advisories  # Must pass
```

### Platform Parity

Changes must consider all supported platforms:

- Linux x64/arm64 (glibc + musl)
- macOS arm64
- Windows x64

## Key Files

| Path                         | Purpose                                    |
| ---------------------------- | ------------------------------------------ |
| `config/agentic/roles/`      | In-repo role definitions                   |
| `crates/ipcprims-transport/` | Low-level transport (UDS, named pipes)     |
| `crates/ipcprims-frame/`     | Wire format codec and channel multiplexing |
| `crates/ipcprims-schema/`    | Optional JSON Schema validation            |
| `crates/ipcprims-peer/`      | High-level peer connection management      |
| `crates/ipcprims/`           | Umbrella crate + CLI binary                |
| `deny.toml`                  | License and security policy                |

## Roles

Role definitions live in [`config/agentic/roles/`](config/agentic/roles/) — all roles are in-repo with ipcprims-specific customizations extending crucible baselines.

| Role           | Source                                            | Focus                               |
| -------------- | ------------------------------------------------- | ----------------------------------- |
| `devlead`      | [in-repo](config/agentic/roles/devlead.yaml)      | Implementation, wire format, safety |
| `deliverylead` | [in-repo](config/agentic/roles/deliverylead.yaml) | Readiness, delivery coordination    |
| `secrev`       | [in-repo](config/agentic/roles/secrev.yaml)       | Security, input validation, FFI     |
| `qa`           | [in-repo](config/agentic/roles/qa.yaml)           | Testing, cross-platform             |
| `releng`       | [in-repo](config/agentic/roles/releng.yaml)       | CI/CD + platform validation         |
| `cicd`         | [in-repo](config/agentic/roles/cicd.yaml)         | Pipelines, runners, matrix          |
| `infoarch`     | [in-repo](config/agentic/roles/infoarch.yaml)     | Docs, schemas, standards            |
| `ffiarch`      | Project-specific (see below)                      | Bindings, cross-language            |

### Role: devlead

**Source**: [`config/agentic/roles/devlead.yaml`](config/agentic/roles/devlead.yaml)

Default role for implementation. Extended with ipcprims wire format safety and cross-platform focus.

#### Key Extensions

- Rust implementation across all crates
- Cross-platform transport abstraction
- Wire format codec implementation
- FFI boundary implementation

### Role: secrev

**Source**: [`config/agentic/roles/secrev.yaml`](config/agentic/roles/secrev.yaml)

Security review with emphasis on input validation and FFI safety.

#### Key Extensions

- Wire format parsing security review
- Buffer overflow prevention in frame codec
- FFI boundary security review
- Untrusted peer input handling

### Role: qa

**Source**: [`config/agentic/roles/qa.yaml`](config/agentic/roles/qa.yaml)

Testing and quality assurance with cross-platform focus.

### Role: ffiarch

FFI Architect — Bindings design and cross-language integration.

#### Scope

- C-ABI design and cbindgen configuration
- Language binding implementation (Go, Python, TypeScript)
- Memory ownership contracts across FFI
- Wire format compatibility across languages

## Standards Reference

- **Online**: https://crucible.3leaps.dev/
- **FulmenHQ patterns**: https://github.com/fulmenhq/crucible
- **Local decisions**: `docs/decisions/` (ADR, DDR, SDR)

## Contact

- **Lead maintainer**: See MAINTAINERS.md
- **Repository**: https://github.com/3leaps/ipcprims

---

**Last Updated**: February 6, 2026
